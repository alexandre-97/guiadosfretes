{% extends 'base.html' %}
{% load static %}

{% block title %}Meus Dados{% endblock %}
{% block page_title %}Meus Dados e Conex√µes{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header"><h5 class="card-title">Informa√ß√µes do Perfil</h5></div>
            <div class="card-body">
                <form method="post">
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="mb-3">
                    <label class="form-label">Nome Completo</label>
                    {{ form.nome_completo }}
                    {% for error in form.nome_completo.errors %}
                        <div class="text-danger mt-1 small">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    <label class="form-label">Seu WhatsApp</label>
                    {{ form.telefone_whatsapp }}
                    {% for error in form.telefone_whatsapp.errors %}
                        <div class="text-danger mt-1 small">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header"><h5 class="card-title">Conex√£o com WhatsApp</h5></div>
            <div class="card-body text-center">
                {% if tem_api_configurada %}
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <span class="me-2">Status da Conex√£o:</span>
                        <div id="status-spinner" class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Verificando...</span>
                        </div>
                        <span id="status-badge" class="badge"></span>
                    </div>
                    <p id="status-text">Verificando o status da sua conex√£o...</p>
                    
                    <a href="#" id="btnGerarQRCode" class="btn btn-success d-none">
                        <i class="ti ti-qrcode me-1"></i> Conectar ou Gerar Novo QR Code
                    </a>
                    <hr>
                    
                    {% if messages %}
                        {% for message in messages %}
                            {% if 'QR Code gerado' in message.tags or 'j√° est√° conectada' in message.tags or 'Erro da Mega API' in message.tags or 'success' in message.tags %}
                            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-success{% endif %}">{{ message }}</div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    
                    <div class="mt-3" id="qr-code-display">
                        </div>

                {% else %}
                    <div class="alert alert-warning">A integra√ß√£o com a API do WhatsApp n√£o est√° configurada.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const btnGerarQRCode = document.getElementById('btnGerarQRCode');
    
    // S√≥ executa o script se a API estiver configurada e o bot√£o existir
    if (btnGerarQRCode) {
        const statusSpinner = document.getElementById('status-spinner');
        const statusBadge = document.getElementById('status-badge');
        const statusText = document.getElementById('status-text');
        const qrCodeDisplay = document.getElementById('qr-code-display');
        
        // Fun√ß√£o auxiliar para mostrar mensagens
        function mostrarMensagem(message, type) {
            // Se houver uma forma de exibir mensagens tempor√°rias sem recarregar
            // Aqui vamos usar um alerta simples
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        /**
         * Verifica o status da API no backend (chamando a view verificar_status_whatsapp_api)
         */
        function checkConnectionStatus() {
            // Mostra o spinner enquanto verifica
            statusSpinner.classList.remove('d-none');
            
            fetch("{% url 'perfil:api_verificar_status' %}")
                .then(response => response.json())
                .then(data => {
                    // Esconde o spinner
                    statusSpinner.classList.add('d-none');
                    btnGerarQRCode.classList.remove('d-none'); // Garante que o bot√£o aparece

                    // Fun√ß√£o auxiliar para atualizar o display
                    function updateDisplay(status, textContent, badgeClass, isPending) {
                        statusBadge.textContent = status;
                        statusBadge.className = 'badge ' + badgeClass;
                        statusText.innerHTML = textContent;
                        // Oculta o bot√£o se estiver conectado, ou se estiver PENDING_QR e o QR j√° foi exibido.
                        btnGerarQRCode.classList.toggle('d-none', status === 'Conectado');
                        
                        if (isPending) {
                            // Se o status √© PENDING_QR, chamamos a fun√ß√£o para buscar e exibir o QR Code
                            // Isso √© crucial para o polling!
                            if (qrCodeDisplay.innerHTML === '') {
                                fetchAndDisplayQRCode(false); // N√£o for√ßa o spinner do bot√£o
                            }
                        } else {
                            // Caso contr√°rio, limpamos o display do QR Code
                            qrCodeDisplay.innerHTML = '';
                        }
                    }

                    // --- L√≥gica de Status Unificada ---
                    if (data.status === 'CONNECTED') {
                        updateDisplay('Conectado', 'Sua conta de WhatsApp est√° conectada e pronta para enviar mensagens.', 'bg-success', false);
                        
                    } else if (data.status === 'PENDING_QR') {
                        // Se a API est√° no estado PENDING (aguardando a leitura do QR Code)
                        updateDisplay('Aguardando Leitura', 'QR Code gerado! Abra o WhatsApp e escaneie o c√≥digo abaixo.', 'bg-warning', true);
                        
                    } else { // DISCONNECTED, API_ERROR, NO_CONFIG, etc.
                        updateDisplay('Desconectado', 'Sua conta de WhatsApp est√° desconectada. <strong>Clique no bot√£o abaixo para gerar um QR Code e reconectar.</strong>', 'bg-danger', false);
                    }
                })
                .catch(() => {
                    statusSpinner.classList.add('d-none');
                    btnGerarQRCode.classList.remove('d-none');
                    statusBadge.textContent = 'Erro de API';
                    statusBadge.className = 'badge bg-warning';
                    statusText.textContent = 'N√£o foi poss√≠vel verificar o status. A API pode estar offline.';
                    qrCodeDisplay.innerHTML = '';
                });
        }

        btnGerarQRCode.addEventListener('click', function(event) {
            event.preventDefault(); // Impede o redirecionamento do link '#'
            
            // Limpa a √°rea do QR e mostra o spinner enquanto a requisi√ß√£o √© feita
            qrCodeDisplay.innerHTML = ''; 
            statusSpinner.classList.remove('d-none');
            
            // Chama a fun√ß√£o que faz o POST/GET para iniciar/obter o QR Code
            fetchAndDisplayQRCode(true); // For√ßa o spinner do bot√£o
        });
        
        /**
         * Chama a view do Django para gerar/obter o QR Code em Base64
         * @param {boolean} showLoading indica se o spinner deve ser for√ßado
         */
        function fetchAndDisplayQRCode(showLoading) {
            if (showLoading) {
                statusSpinner.classList.remove('d-none');
            }
            
            fetch("{% url 'perfil:gerar_qrcode' %}")
                .then(response => {
                    // Se a resposta HTTP for 400 ou 500, ainda tentamos ler o JSON para a mensagem de erro
                    if (!response.ok && response.status !== 400) {
                         // Lan√ßa erro real se n√£o for 200 (sucesso) ou 400 (erro esperado)
                         throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    statusSpinner.classList.add('d-none');

                    // üö® CORRE√á√ÉO PRINCIPAL: Usa a chave 'qr_code' e a chave 'success'
                    if (data.success) {
                        if (data.qr_code) {
                            // Se recebeu o Base64, exibe diretamente
                            qrCodeDisplay.innerHTML = `
                                <p class="fw-bold">Escaneie o c√≥digo abaixo com seu WhatsApp:</p>
                                <img src="${data.qr_code}" alt="QR Code para conectar WhatsApp" class="img-fluid" style="max-width: 256px; border-radius: 8px;">
                            `;
                            // Atualiza o status para PENDING_QR
                            statusText.innerHTML = 'QR Code gerado! Abra o WhatsApp e escaneie o c√≥digo abaixo.';
                            statusBadge.textContent = 'Aguardando Leitura';
                            statusBadge.className = 'badge bg-warning';
                            btnGerarQRCode.classList.add('d-none');
                            
                        } else {
                            // Caso especial: success=true, mas sem qr_code (i.e., est√° CONECTADO via CONECTADO: prefixo)
                            // For√ßa a atualiza√ß√£o do status para refletir a conex√£o imediatamente
                            checkConnectionStatus(); 
                        }
                    } else {
                        // success=false: Houve um erro real.
                        qrCodeDisplay.innerHTML = `<div class="alert alert-danger mt-3">${data.message || 'Erro desconhecido ao gerar QR Code.'}</div>`;
                        // Atualiza o status para DISCONNECTED
                        checkConnectionStatus(); 
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar QR Code:", error);
                    statusSpinner.classList.add('d-none');
                    qrCodeDisplay.innerHTML = `<div class="alert alert-danger mt-3">Erro de conex√£o ao tentar buscar o QR Code.</div>`;
                    // Atualiza o status para API_ERROR
                    checkConnectionStatus(); 
                });
        }
        
        // --- Inicializa√ß√£o e Polling (Verifica√ß√£o Cont√≠nua) ---
        function initializeStatusPolling() {
            checkConnectionStatus();
            // Inicia o loop de verifica√ß√£o a cada 5 segundos
            setInterval(checkConnectionStatus, 5000); 
        }

        initializeStatusPolling(); // Chamada inicial
    }
});
</script>
{% endblock page_scripts %}